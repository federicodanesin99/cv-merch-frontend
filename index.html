<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CLASSE VENETA Merch - Pre-Order Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
    }
    
    .product-card {
      transition: all 0.3s ease;
    }
    
    .product-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.1);
    }
    
    .color-swatch {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .color-swatch:hover {
      transform: scale(1.1);
    }
    
    .color-swatch.selected {
      border-color: #000;
      box-shadow: 0 0 0 2px #fff, 0 0 0 4px #000;
    }
    
    .size-btn {
      transition: all 0.2s;
    }
    
    .size-btn:hover {
      transform: scale(1.05);
    }
    
    .size-btn.selected {
      background: #000;
      color: #fff;
    }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <div class="w-12 h-12 bg-black rounded-lg flex items-center justify-center text-white font-bold text-xl">
          M
        </div>
        <div>
          <h1 class="text-xl font-bold">CLASSE VENETA</h1>
          <p class="text-xs text-gray-500">Merchandise Store</p>
        </div>
      </div>
      <div id="cart-icon" class="relative cursor-pointer">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
        <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
      </div>
    </div>
  </header>

  <!-- Hero Banner -->
  <section class="bg-gradient-to-r from-gray-900 to-gray-700 text-white py-16">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <h2 class="text-4xl md:text-5xl font-bold mb-4">Pre-Order Esclusivo</h2>
      <p class="text-xl mb-2">Prezzi di lancio fino a <span class="text-yellow-400 font-bold">-20%</span></p>
      <p class="text-gray-300">Ordina ora, ricevi entro 3 settimane</p>
    </div>
  </section>

  <!-- Products -->
  <section class="max-w-6xl mx-auto px-4 py-12">
    <div id="products-container" class="grid md:grid-cols-2 gap-8">
      <!-- Prodotti caricati dinamicamente -->
    </div>
  </section>

  <!-- Cart Summary (sticky bottom) -->
  <div id="cart-summary" class="hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex justify-between items-center mb-4">
        <div>
          <p class="text-sm text-gray-600">Totale carrello</p>
          <p class="text-2xl font-bold">â‚¬<span id="cart-total">0.00</span></p>
          <p id="bundle-discount-info" class="text-sm text-green-600 hidden"></p>
        </div>
        <button onclick="openCheckout()" class="bg-black text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-800 transition">
          Procedi al Checkout
        </button>
      </div>
      <div id="cart-items-preview" class="text-sm text-gray-600"></div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkout-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold">Completa l'ordine</h3>
          <button onclick="closeCheckout()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <form id="checkout-form" onsubmit="handleCheckout(event)">
          <!-- Dati cliente -->
          <div class="mb-6">
            <h4 class="font-semibold mb-3">I tuoi dati</h4>
            <input type="email" id="customer-email" required placeholder="Email *" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3">
            <input type="text" id="customer-name" placeholder="Nome completo (opzionale)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>

          <!-- Riepilogo -->
          <div class="mb-6">
            <h4 class="font-semibold mb-3">Riepilogo ordine</h4>
            <div id="checkout-items" class="bg-gray-50 rounded-lg p-4 mb-4"></div>
            <div class="flex justify-between items-center text-lg font-bold">
              <span>Totale</span>
              <span>â‚¬<span id="checkout-total">0.00</span></span>
            </div>
          </div>

          <!-- Metodo pagamento -->
          <div class="mb-6">
            <h4 class="font-semibold mb-3">Metodo di pagamento</h4>
            <div class="grid grid-cols-2 gap-4">
              <label class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-500 transition">
                <input type="radio" name="payment" value="paypal" checked class="mr-2">
                <span class="font-semibold">PayPal</span>
              </label>
              <label class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-500 transition">
                <input type="radio" name="payment" value="revolut" class="mr-2">
                <span class="font-semibold">Revolut</span>
              </label>
            </div>
          </div>

          <button type="submit" class="w-full bg-black text-white py-4 rounded-lg font-semibold text-lg hover:bg-gray-800 transition">
            Conferma e vai al pagamento
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://cv-merch-backend.onrender.com'; // Modifica con il tuo URL
    let products = [];
    let cart = [];
    let bundleDiscount = 5;

    // Carica prodotti
    async function loadProducts() {
      try {
        const res = await fetch(`${API_URL}/api/products`);
        const data = await res.json();
        products = data.products;
        bundleDiscount = data.bundleDiscount;
        renderProducts();
      } catch (err) {
        console.error('Errore caricamento prodotti:', err);
      }
    }

    // Render prodotti
    function renderProducts() {
      const container = document.getElementById('products-container');
      container.innerHTML = products.map(product => `
        <div class="product-card bg-white rounded-lg shadow-md overflow-hidden">
          <div class="bg-gray-200 h-64 flex items-center justify-center">
            <span class="text-gray-400 text-6xl">ðŸ‘•</span>
          </div>
          <div class="p-6">
            <h3 class="text-xl font-bold mb-2">${product.name}</h3>
            <p class="text-2xl font-bold text-gray-900 mb-4">â‚¬${product.price.toFixed(2)}</p>
            
            <div class="mb-4">
              <label class="block text-sm font-semibold mb-2">Colore</label>
              <div class="flex gap-2">
                ${product.colors.map((color, i) => `
                  <div class="color-swatch ${i === 0 ? 'selected' : ''}" 
                       style="background-color: ${getColorHex(color)}"
                       onclick="selectColor('${product.id}', '${color}', this)"
                       title="${color}">
                  </div>
                `).join('')}
              </div>
            </div>

            <div class="mb-4">
              <label class="block text-sm font-semibold mb-2">Taglia</label>
              <div class="flex gap-2">
                ${product.sizes.map((size, i) => `
                  <button class="size-btn px-4 py-2 border rounded ${i === 0 ? 'selected' : ''}"
                          onclick="selectSize('${product.id}', '${size}', this)">
                    ${size}
                  </button>
                `).join('')}
              </div>
            </div>

            <div class="flex items-center gap-4">
              <input type="number" id="qty-${product.id}" value="1" min="1" max="10" 
                     class="w-20 px-3 py-2 border rounded text-center">
              <button onclick="addToCart('${product.id}')" 
                      class="flex-1 bg-black text-white py-2 rounded font-semibold hover:bg-gray-800 transition">
                Aggiungi al carrello
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function getColorHex(colorName) {
      const colors = {
        'Military Green': '#4a5d4f',
        'Blue Navy': '#1e3a5f',
        'Dark Heather': '#3c3c3c',
        'Maroon': '#800020',
        'Dark Chocolate': '#3d2b1f'
      };
      return colors[colorName] || '#666';
    }

    function selectColor(productId, color, el) {
      el.parentElement.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
      el.classList.add('selected');
    }

    function selectSize(productId, size, el) {
      el.parentElement.querySelectorAll('.size-btn').forEach(s => s.classList.remove('selected'));
      el.classList.add('selected');
    }

    function addToCart(productId) {
      const product = products.find(p => p.id === productId);
      const color = document.querySelector(`#products-container [onclick*="${productId}"].color-swatch.selected`)?.title || product.colors[0];
      const size = document.querySelector(`#products-container [onclick*="${productId}"].size-btn.selected`)?.textContent.trim() || product.sizes[0];
      const qty = parseInt(document.getElementById(`qty-${productId}`).value);

      cart.push({ product, color, size, quantity: qty });
      updateCart();
      
      // Feedback visivo
      const btn = event.target;
      btn.textContent = 'âœ“ Aggiunto!';
      setTimeout(() => btn.textContent = 'Aggiungi al carrello', 1000);
    }

    function updateCart() {
      const summary = document.getElementById('cart-summary');
      const count = document.getElementById('cart-count');
      
      if (cart.length === 0) {
        summary.classList.add('hidden');
        count.classList.add('hidden');
        return;
      }

      summary.classList.remove('hidden');
      count.classList.remove('hidden');
      count.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);

      // Calcola totale con bundle
      let subtotal = cart.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
      
      // Applica sconto bundle
      const sizeCounts = {};
      cart.forEach(item => {
        sizeCounts[item.size] = (sizeCounts[item.size] || 0) + item.quantity;
      });
      const hasBundle = Object.values(sizeCounts).some(count => count >= 2);
      const discount = hasBundle ? subtotal * (bundleDiscount / 100) : 0;
      const total = subtotal - discount;

      document.getElementById('cart-total').textContent = total.toFixed(2);
      
      const discountInfo = document.getElementById('bundle-discount-info');
      if (hasBundle) {
        discountInfo.textContent = `ðŸŽ‰ Sconto bundle ${bundleDiscount}% applicato: -â‚¬${discount.toFixed(2)}`;
        discountInfo.classList.remove('hidden');
      } else {
        discountInfo.classList.add('hidden');
      }

      // Preview items
      document.getElementById('cart-items-preview').innerHTML = 
        cart.map(item => `${item.quantity}x ${item.product.name} (${item.color}, ${item.size})`).join(' â€¢ ');
    }

    function openCheckout() {
      const modal = document.getElementById('checkout-modal');
      modal.classList.remove('hidden');
      
      // Popola riepilogo
      const itemsHtml = cart.map(item => `
        <div class="flex justify-between mb-2">
          <span>${item.quantity}x ${item.product.name} - ${item.color} (${item.size})</span>
          <span>â‚¬${(item.product.price * item.quantity).toFixed(2)}</span>
        </div>
      `).join('');
      document.getElementById('checkout-items').innerHTML = itemsHtml;
      document.getElementById('checkout-total').textContent = document.getElementById('cart-total').textContent;
    }

    function closeCheckout() {
      document.getElementById('checkout-modal').classList.add('hidden');
    }

    async function handleCheckout(e) {
      e.preventDefault();
      
      const email = document.getElementById('customer-email').value;
      const name = document.getElementById('customer-name').value;
      const payment = document.querySelector('input[name="payment"]:checked').value;

      const orderData = {
        customerEmail: email,
        customerName: name,
        paymentMethod: payment,
        items: cart.map(item => ({
          productId: item.product.id,
          color: item.color,
          size: item.size,
          quantity: item.quantity
        }))
      };

      try {
        const res = await fetch(`${API_URL}/api/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        });

        const data = await res.json();
        
        // Redirect al pagamento
        window.location.href = data.paymentUrl;
        
      } catch (err) {
        alert('Errore durante la creazione dell\'ordine. Riprova.');
        console.error(err);
      }
    }

    // Init
    loadProducts();
  </script>

</body>
</html>
